---
title: "Assignment - Mini Challenge 2"
description: |
  A short description of the post.
author:
  - name: Yu Yaxin
    url: {}
date: 07-12-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 3
    number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1.Overview
### 1.1 Background
This report is based on the mini challenge 2 from [VAST Challenge 2021](https://vast-challenge.github.io/2021/). Here is the background: 

GAStech, an oil-products company from Tethys, is expanding into Kronos - an island country, built good relations with the local government as well.Not only GAStech got considerable profit, but also has an impact on the local natural environment.
At the beginning of 1997,the residents of Elodis agricultural town located near the capital of Kronos began to pay attention to an abnormal increase in the occurrence of illnesses such as cancer and birth defects.And they believe this is related to Gastech's business. The residents set up their own POK (Protectors of Kronos) organization to protect the ecological environment in Kronos and prevent continuous deterioration.

During Gastech's celebration party in 2014, the unexplained disappearance of some employees was suspected to be related to the POK organization. And now we got the employees' credit card and loyalty card transaction data, and also their GPS record, to identify anomalies. Due to this, the purpose of this report is to analyze the consumption behaviors of employees at different times and places, use R Studio to visualize the data, screen the existing suspicious behaviors, match the employees with varies of crads, and draw suggestions and conclusions.

### 1.2 literature review
R Studio was originally developed by Robert Gentleman and Ross Ihaka, an integrated development environment (IDE) for the R language. It is a standalone open source project that integrates many powerful programming tools into an intuitive, easy-to-learn interface. This visualizing analysis is based on R Studio, therefore, will introduce some of the R packages. 

The tidyverse is a language for solving data science challenges with R code, encompasses the repeated tasks at the heart of every data science project:data import, tidying, manipulation, visualization, and programming. Its primary goal is to facilitate a conversation between a human and a computer about data.(Hadley Wickham, Mara Averick,etc,2019)

The tidyverse also provides the ggplot2 (Wickham, 2016) package for visualization. [ggplot2](https://ggplot2.tidyverse.org/) is a system for declaratively creating graphics, based on The Grammar of Graphics (Wilkinson, 2005).Data transformation is supported by the core dplyr (Wickham et al., 2019a) package. [dplyr](https://dplyr.tidyverse.org/)
provides verbs that work with whole data frames, such as mutate() to create new variables,filter() to find observations matching given criteria.  

R can be used for visualization and supports various types of charts. It supports
many applications that can be visualized in a simple and contains most of the
information in the plot.The library ggplot() supports visualization for various formats of data and machine learning models. The other libraries that support visualization in R are ggiraph, digraph, ggVis and so on(K. G. SrinivasaSiddesh G. M.Srinidhi H.,2018).


### 1.3 Dataset introduced
MC2 includes 4 CSV format files and a tourist map of Abila with locations of interest identified.  
-- Car-assignments: includes 45 detailed records of vehicle assignments by employees.  
-- Cc_data: contains 1491 credit and debit card transaction amount records in various of locations.  
-- Loyalty_data: 1393 observations of loyalty card transaction of GAStech's employees.  
-- Gps: records the latitude and longitude by each employees' track.

## 2. Data preperation
### 2.1 Import data
**(i) Install R packages**  

The first step is to install all the packages we will use in a follow-up study. Here will give brief introduction of some packages.  

We use **Tidyverse** to manipulate and clean original dataset, includes ggplot2(wich is mainly for data visualization), dplyr, tidyr, and purrr. **GGiraph** is to make ggplot interactive with users. **Plotly**'s R graphing library makes interactive, publication-quality graphs.The goal of **patchwork** package is to make it ridiculously simple to combine separate ggplots into the same graphic. **visNetwork** is an R package for network visualization. **lubridate** can help to make up for R Studio's lack of processing time data and makes it much easier. The aim of **magrittr** is to decrease development time and improve readability and maintainability of code. With the **tmap** package, thematic maps can be generated with great flexibility. The **raster** package provides classes and functions to manipulate geographic data in ’raster’ format. **igraph** is a collection of libraries for creating and manipulating graphs and analyzing networks.

```{r}
packages = c('ggiraph', 'plotly', 'DT', 'patchwork',
             'tidyverse','visNetwork','clock','lubridate',
             'raster', 'sf','tmap','rgdal',
             'igraph','tidygraph','magrittr')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

**(ii) Files importing**
Import the four datasets.

```{R}
LoyaltyCard <- read.csv("D:/Study/Visual Analytics/Assignment/MC2/loyalty_data.csv")
CC <- read.csv("D:/Study/Visual Analytics/Assignment/MC2/cc_data.csv")
GPS <- read.csv("D:/Study/Visual Analytics/Assignment/MC2/gps.csv")
CarTrack <- read.csv("D:/Study/Visual Analytics/Assignment/MC2/car-assignments.csv")
```

Here is a roughly view of information in each dataset.

```{r}
glimpse(LoyaltyCard)
glimpse(CC)
glimpse(GPS)
glimpse(CarTrack)
```

### 2.2 Clean and tidy data
**(i)Missing values checking**  
The first thing to do is to check whether there is missing value, here we use is.na fuction.

```{r}
which(rowSums(is.na(LoyaltyCard))==TRUE)
which(rowSums(is.na(CC))==TRUE)
which(rowSums(is.na(GPS))==TRUE)
which(rowSums(is.na(CarTrack))==TRUE)
na.omit(CarTrack)
```

If the result gets 0, means the inexistence of missing. We can draw from the conclusion that three of the datasets do not have any missing except CarTrack. If we go back to check this dataset, we will find that the missing values are all the IDs of drivers whose in Gastech company, which are not very useful for our subsequent research, so we can choose to delete them by using na.omit function.

**(ii)Adjust data type and format**

From our previous brief glimpse of the data, the data type of "timestamp" column is incorrect. It should be in "date" format but is mistaken for "character" format, so here we use date_time_parse to modify it, and also extracts the hours and days as new columns in "CC" and "LoyaltyCard" respectively.

For CC dataset:

```{r}
CC$timestamp <- date_time_parse(as.character(CC$timestamp),
                zone = "",
                format = "%m/%d/%Y %H:%M")
CC$hour <- as.numeric(get_hour(CC$timestamp))
a <- as.character(CC$timestamp)
```

For LoyaltyCard dataset:

```{r}
LoyaltyCard$timestamp <- date_time_parse(as.character(LoyaltyCard$timestamp),
                zone = "",
                format = "%m/%d/%Y")
LoyaltyCard$day <- as.factor(get_day(LoyaltyCard$timestamp))
```

**(iii)Derive new column**

In the CarTrack dataset, we found the first name and last name were mistakenly divided into two columns, due to this, we combined them into one column with paste function.

```{r}
CarTrack$Name <- paste(CarTrack$FirstName, CarTrack$LastName)
CarTrack <- CarTrack %>% 
  select(CarID,CurrentEmploymentTitle,CurrentEmploymentType,Name)
```

## 3 Find anomalies 
### 3.1 Identify the most popular locations
**(i) For loyalty card transactions**
```{r}
LoyaltyCard_3 <- LoyaltyCard %>% 
  select(location,day) %>% 
  group_by(location,day) %>%  
  summarize(Count=n())
```
```{r}
Bar <- plot_ly(data=LoyaltyCard_3,
  x = ~Count,
  y = ~location,
  type = "bar"
) %>%
  layout(title ='Total number of loyalty card transactions')

Bar
```

```{r}

LoyaltyCard_3$day <- as.numeric(LoyaltyCard_3$day)
LoyaltyCard_3$location <- as.factor(LoyaltyCard_3$location)

BAR2 <-  plot_ly(data=LoyaltyCard_3,
    x = ~Count, 
    y = ~location, 
    color = ~location, 
    frame = ~day, 
    text = ~paste("Day:", day,     
                  "<br>Count:", Count,
                  "<br>location:",location), 
    hoverinfo = "text",
    type = 'bar',
    mode = 'markers'
  )
BAR2 <- BAR2 %>% layout(
    xaxis = list(
      type = "log"
    )
  ) %>%
layout(title ='Most popular location of loyalty card transaction by day')


BAR2
```

**(ii) For credit card transactions**

```{r}
CC_4 <- CC %>%
  select(location,hour) %>% 
  group_by(location,hour) %>%  
  summarize(Count=n())
```
```{r}
Bar2 <- plot_ly(data=CC_4,
  x = ~Count,
  y = ~location,
  type = "bar"
) %>%
  layout(title ='Total number of credit card transactions')

Bar2

```

```{r}
Heatmap <- plot_ly(data=CC_4,
                   x= ~hour,
                   y= ~location,
                   z= ~Count,
                   text = ~paste("Hour:", hour,     
                                 "<br>Count:", Count,
                                 "<br>location:",location), 
                   hoverinfo = "text",
                   type = "heatmap") %>%
  layout(tittle = 'Most popular location of credit card transaction by hour')
Heatmap

```


### 3.2 Visualization
```{R}
bgmap <- raster("D:/Study/Visual Analytics/Mavis-yuuu/Mavis_blog_ISSS608/_posts/2021-07-12-assignment/MC2-tourist.tif")
bgmap
tm_shape(bgmap) +
tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255)
```

```{r}
Abila_st <- st_read(dsn = "./Geospatial",
                    layer = "Abila")
gps <- read_csv("D:/Study/Visual Analytics/Assignment/MC2/gps.csv")
glimpse(gps)

gps$Timestamp <- date_time_parse(gps$Timestamp,
                zone = "",
                format = "%m/%d/%Y %H:%M:%S")
gps$day <- as.factor(get_day(gps$Timestamp))
gps_sf <- st_as_sf(gps, 
                   coords = c("long", "lat"),
                       crs= 4326)
gps_sf
```

```{r}
gps_path <- gps_sf %>%
  group_by(id, day) %>%
  summarize(m = mean(Timestamp), 
            do_union=FALSE) %>%
  st_cast("LINESTRING")
gps_path
```

```{r}
gps_path_selected <- gps_path %>%
  filter(id==1)
tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path_selected) +
  tm_lines()
```

```{r}
m <- tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path) +
  tm_lines() +
  tm_facets(along = "id")
```

**(i)Find the anomalies**

